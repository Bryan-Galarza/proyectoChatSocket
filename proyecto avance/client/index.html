<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Grupal</title>
  <link rel="stylesheet" href="./estilos/chat.css">
  <script type="module">
    import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js'
    
    let currentRoom = null
    let currentTarget = null

    //Funcion para pedir username al usuario
    const promptUsername = () => new Promise((resolve) => {
      const modal = document.getElementById('username-modal')
      const form = document.getElementById('username-form')
      const inputField = document.getElementById('username-input')
      const skipButton = document.getElementById('username-skip')

      const cleanup = () => {
        form.removeEventListener('submit', onSubmit)
        skipButton.removeEventListener('click', onSkip)
        modal.classList.remove('is-open')
      }

      const onSubmit = (event) => {
        event.preventDefault()
        const value = inputField.value.trim()
        cleanup()
        resolve(value || null)
      }

      const onSkip = () => {
        cleanup()
        resolve(null)
      }

      form.addEventListener('submit', onSubmit)
      skipButton.addEventListener('click', onSkip)
      modal.classList.add('is-open')
      inputField.focus()
    })

    //Obtener el username del usuario o generar uno con randomuser
    const getUsername = async () => {
      const username = localStorage.getItem('username')
      if (username && username !== "undefined") return username

      const manualUsername = await promptUsername()
      if (manualUsername) {
        localStorage.setItem('username', manualUsername)
        return manualUsername
      }
      
      try {
        const res = await fetch('https://randomuser.me/api/0.8/?results=1');
        const data = await res.json();
        const randomUsername = data.results[0].user.username;

        console.log("Fetched new username:", randomUsername);
        localStorage.setItem('username', randomUsername);
        return randomUsername;
      } catch (error) {
        console.error("Fetch failed:", error);
      }
    }

    const socket = io({
      auth: {username: await getUsername(), serverOffset: 0}
    })

    //constantes
    const form = document.getElementById('form')
    const input = document.getElementById('input')
    const messages = document.getElementById('messages')
    const statusMessages = document.getElementById('status-messages')
    const notificationList = document.getElementById('notification-list')
    const headerTitle = document.getElementById('header-title')
    const backButton = document.getElementById('back-button')
    const currentUser = socket.auth.username

    //Configuracion de notificaciones
    if (!localStorage.getItem('notifications')) {
      localStorage.setItem('notifications', JSON.stringify([]))
    }

    function updateNotificationList() {
      const notifications = JSON.parse(localStorage.getItem('notifications'))
      notificationList.innerHTML = ''
      
      if (notifications.length === 0) {
        notificationList.innerHTML = '<li style="padding: 10px; color: #888;">No hay notificaciones</li>'
        return
      }

      notifications.forEach(notif => {
        const item = document.createElement('li')
        item.className = 'notification-item'
        item.innerHTML = `<strong>${notif.user}</strong><small>Nuevo mensaje</small>`
        item.style.cssText = 'padding: 10px; border-bottom: 1px solid #333; cursor: pointer; background: #2a2a2a; margin-bottom: 5px; border-radius: 5px;'
        
        item.addEventListener('click', () => {
          openPrivateChat(notif.user)
          const updated = notifications.filter(n => n.user !== notif.user)
          localStorage.setItem('notifications', JSON.stringify(updated))
          updateNotificationList()
        })
        
        notificationList.appendChild(item)
      })
    }

    function showNotification(fromUser, roomId) {
      console.log('Mostrando notificación de:', fromUser, 'room:', roomId)
      const notifications = JSON.parse(localStorage.getItem('notifications'))
      const existing = notifications.find(n => n.user === fromUser)
      
      if (!existing) {
        notifications.push({ user: fromUser, roomId, timestamp: Date.now() })
        localStorage.setItem('notifications', JSON.stringify(notifications))
        updateNotificationList()
      }
    }

    //Configuraciones del chat
    function openPrivateChat(targetUser) {
      if (targetUser === currentUser) return

      const roomId = [currentUser, targetUser].sort().join('-')
      currentRoom = roomId
      currentTarget = targetUser
      
      headerTitle.textContent = `Chat con ${targetUser}`
      backButton.style.display = 'block'

      messages.innerHTML += `<li style="text-align: center; color: #888; font-style: italic; background: transparent;">
        --- Chat privado con ${targetUser} ---
      </li>`
      
      socket.emit('join:private', roomId)
    }

    function returnToGeneral() {
      currentRoom = null
      currentTarget = null
      headerTitle.textContent = 'Chat General'
      backButton.style.display = 'none'

      messages.innerHTML += `<li style="text-align: center; color: #888; font-style: italic; background: transparent;">
        --- Volviendo al chat general --- </li>`
      socket.auth.serverOffset = 0
    }

    //Event Listeners
    backButton.addEventListener('click', returnToGeneral)

    statusMessages.addEventListener('click', (e) => {
      const li = e.target.closest('.user-item')
      if (!li) return
      
      const targetUser = li.dataset.username || li.textContent.split(' (')[0] // Cambio aquí
      if (targetUser !== currentUser) {
        openPrivateChat(targetUser)
      }
    })

    //Enviar mensaje segun corresponda
    form.addEventListener('submit', (e) => {
      e.preventDefault()
      const msg = input.value.trim()
      if (!msg) return
      //Si es mensaje privado
      if (currentRoom && currentTarget) {
        socket.emit('chat:private', {
          msg: msg,
          roomId: currentRoom,
          target: currentTarget
        })
        messages.insertAdjacentHTML('beforeend', `
          <li style="text-align: right; background: #1a3a5f;">
            <small style="color: #09f;">Tú (privado)</small>
            <p>${msg}</p>
          </li>
        `)
      } else {
        socket.emit('chat:general', msg)
      }
      
      input.value = ''
      messages.scrollTop = messages.scrollHeight
    })

    //Escucha del socket
    socket.on('chat message', (msg, serverOffset, username) => {
      messages.insertAdjacentHTML('beforeend', `
        <li>
          <small>${username}</small>
          <p>${msg}</p>
        </li>
      `)
      socket.auth.serverOffset = serverOffset
      messages.scrollTop = messages.scrollHeight
    })

    socket.on('private message', ({ msg, username, roomId }) => {
      console.log('Mensaje privado recibido:', { msg, username, roomId, currentRoom, currentUser })
      
      const roomIdExpected = [currentUser, username].sort().join('-')
      
      if (roomId === roomIdExpected && currentRoom === roomId) {
        if (username !== currentUser) {
          messages.insertAdjacentHTML('beforeend', `
            <li style="background: #000;">
              <small style="color: #09f;">${username} (privado)</small>
              <p>${msg}</p>
            </li>
          `)
        }
      } else if (username !== currentUser) {
        console.log('Mostrando notificación para mensaje de:', username)
        showNotification(username, roomId)
      }
      
      messages.scrollTop = messages.scrollHeight
    })

    //Para mensajes de union o desconexion del chat
    socket.on('user status', ({ username, action }) => {
      if (username === currentUser) return

      if (action === 'join') {
        const item = document.createElement('li')
        item.className = 'user-item'
        item.dataset.username = username
        item.textContent = `${username} se ha unido al chat`
        item.style.cssText = 'cursor:pointer; color:#09f; padding:5px 10px;'
        statusMessages.appendChild(item)

      } else if (action === 'leave') {
        const item = document.createElement('li')
        item.style.cssText = 'color:#888; font-style:italic; padding:5px 10px;'
        item.textContent = `${username} se ha desconectado del chat`
        statusMessages.appendChild(item)
      }
    })

    updateNotificationList()
    
    //Iniciar chat
    const currentUserItem = document.createElement('li')
    currentUserItem.className = 'user-item'
    currentUserItem.dataset.username = currentUser
    currentUserItem.textContent = `${currentUser} (tú)`
    currentUserItem.style.cssText = 'color:#888; padding:5px 10px; margin:2px 0;'
    statusMessages.appendChild(currentUserItem)
  </script>
</head>

<body>
  <div id="username-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="username-title">
    <div class="modal">
      <h2 id="username-title">Ingrese un usuario</h2>
      <p class="modal-subtitle">Si omite este paso se le asignará un usuario aleatorio.</p>
      <form id="username-form" class="modal-form">
        <input id="username-input" type="text" autocomplete="off" placeholder="Tu usuario" maxlength="24">
        <div class="modal-actions">
          <button type="button" id="username-skip" class="btn-secondary">Omitir</button>
          <button type="submit" class="btn-primary">Ingresar</button>
        </div>
      </form>
    </div>
  </div>
  <main class="container">
    <section id="chat">
      <div id="chat-header">
        <button id="back-button" style="display: none;">←</button>
        <h3 id="header-title">Chat General</h3>
      </div>
      <ul id="messages"></ul>
      <form id="form">
        <input id="input" autocomplete="off" placeholder="Escribe un mensaje...">
        <button>Enviar</button>
      </form>
    </section>
    
    <aside id="chatUnidos">
      <h3>Usuarios</h3>
      <ul id="status-messages"></ul>

      <h3 style="margin-top: 20px;">Notificaciones</h3>
      <ul id="notification-list"></ul>
    </aside>
  </main>
</body>
</html>